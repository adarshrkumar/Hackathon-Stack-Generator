---
/**
  * New Chat Page
  *
  * This is the initial chat page for starting a new conversation.
  * It takes the first user message and creates a new thread,
  * then redirects to the specific thread page for further conversation.
  *
  * Features:
  * - Initial message input
  * - Auto-resizing textarea
  * - Loading indicator during API call
  * - Error handling
  * - Automatic redirect to /app/chat/[id] after thread creation
  *
  * Architecture:
  * - Uses the App layout (Nav + Footer)
  * - Client-side TypeScript for API interaction
  * - Redirects to thread-specific page after first message
  */

// Import the application layout
import App from '../../../layouts/App.astro';
import ChatScript from '../../scripts/app/chat.astro';

import '../../../styles/pages/app/chat.scss';

// Clear any existing thread cookie to ensure we start fresh
Astro.cookies.delete('stack-generator-thread-id', { path: '/' });
---

<!-- New Chat Page Content -->
<App title="New Chat">
    <!-- Chat Header Section -->
    <div class="chat-header">
        <h1><i class="fa-solid fa-layer-group"></i> Stack Generator</h1>
        <p class="subtitle">Build your perfect tech stack with AI guidance</p>
    </div>

    <!-- Main Chat Wrapper -->
    <div class="chat-wrapper">
        <!-- Chat Messages Container (scrollable) -->
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome message (always displayed) -->
            <div class="message assistant">
                <div class="message-icon">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div class="message-content">
                    <p><strong>Welcome to Stack Generator!</strong></p>
                    <p>I'll help you design the perfect tech stack for your project.</p>
                    <p>Please describe what type of product or application you're trying to build, and I'll recommend the best technologies, services, and architecture for your needs.</p>
                </div>
            </div>
        </div>

        <!-- Chat Input Section (fixed at bottom) -->
        <div class="chat-input-container">
            <!-- Error Banner (hidden by default) -->
            <div class="error-banner" id="errorBanner"></div>

            <!-- Input Wrapper (textarea + send button) -->
            <div class="input-wrapper">
                <!-- Message Textarea (auto-resizing) -->
                <textarea
                    id="messageInput"
                    placeholder="Type your message here..."
                    rows="1"
                ></textarea>

                <!-- Send Button -->
                <button id="sendButton" class="send-btn">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>

            <!-- Chat Info Bar -->
            <div class="chat-info">
                <span id="threadInfo">New conversation</span>
                <button id="newChatBtn" class="new-chat-btn">
                    <i class="fa-solid fa-plus"></i> New Chat
                </button>
            </div>
        </div>
    </div>
</App>

<!-- Client-Side JavaScript -->
<script is:inline src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
<ChatScript
    serverThreadData={null}
    isThreadPage={false}
/>
