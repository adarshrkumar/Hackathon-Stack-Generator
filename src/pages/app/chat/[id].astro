---
/**
  * AI Chat Interface Page
  *
  * This is the main chat interface for the Stack Generator application.
  * It provides a conversational AI experience powered by AWS Bedrock and Llama 3.1.
  *
  * Features:
  * - Real-time AI chat responses
  * - Thread-based conversation history (server-side loaded)
  * - Auto-resizing textarea input
  * - Loading indicators
  * - Error handling and display
  * - New chat functionality
  * - Keyboard shortcuts (Enter to send, Shift+Enter for newline)
  *
  * Architecture:
  * - Uses the App layout (Nav + Footer)
  * - Server-side rendering with thread history pre-loaded
  * - Client-side TypeScript for interactivity
  * - Communicates with /api/message/generate endpoint
  * - Stores thread ID for conversation context
  */

// Import the application layout
import App from '../../../layouts/App.astro';
import ChatScript from '../../scripts/app/chat.astro';

import '../../../styles/pages/app/chat.scss';

// Server-side imports for thread loading
import { getThread } from '../../../lib/getThread';
import { marked } from 'marked';

// Configure marked for server-side rendering
marked.setOptions({
    breaks: true,  // Convert line breaks to <br>
    gfm: true,     // GitHub Flavored Markdown
});

// Get thread ID from cookie (set by client-side)
const { id } = Astro.params;

// Fetch thread data server-side if thread ID exists in cookie
const serverThreadData = id ? await getThread(id) : null;

// Check if thread was not found (deleted or invalid)
const threadNotFound = (id && id !== '') && !serverThreadData;

// If thread was expected but not found, clear the invalid cookie
if (threadNotFound) {
    Astro.cookies.delete('stack-generator-thread-id', { path: '/' });
}
---

<!-- Chat Page Content -->
<App title="Stack Generator">
    <!-- Chat Header Section -->
    <div class="chat-header">
        <h1><i class="fa-solid fa-layer-group"></i> Stack Generator</h1>
        <p class="subtitle">Build your perfect tech stack with AI guidance</p>
    </div>

    <!-- Main Chat Wrapper -->
    <div class="chat-wrapper">
        <!-- Chat Messages Container (scrollable) -->
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome message (always displayed) -->
            <div class="message assistant">
                <div class="message-icon">
                    <i class="fa-solid fa-robot"></i>
                </div>
                <div class="message-content">
                    <p><strong>Welcome to Stack Generator!</strong></p>
                    <p>I'll help you design the perfect tech stack for your project.</p>
                    <p>Please describe what type of product or application you're trying to build, and I'll recommend the best technologies, services, and architecture for your needs.</p>
                </div>
            </div>

            {/* Server-rendered thread messages (if they exist) */}
            {serverThreadData && serverThreadData.messages.length > 0 && (
                serverThreadData.messages.map((msg) => (
                    <div class={`message ${msg.role}`}>
                        <div class="message-icon">
                            <i class={`fa-solid ${msg.role === 'user' ? 'fa-user' : 'fa-robot'}`}></i>
                        </div>
                        <div class="message-content" set:html={msg.role === 'assistant' ? marked.parse(msg.content) : msg.content.replace(/\n/g, '<br>')}></div>
                    </div>
                ))
            )}
        </div>

        <!-- Chat Input Section (fixed at bottom) -->
        <div class="chat-input-container">
            <!-- Error Banner (hidden by default) -->
            <div class="error-banner" id="errorBanner"></div>

            <!-- Input Wrapper (textarea + send button) -->
            <div class="input-wrapper">
                <!-- Message Textarea (auto-resizing) -->
                <textarea
                    id="messageInput"
                    placeholder="Type your message here..."
                    rows="1"
                ></textarea>

                <!-- Send Button -->
                <button id="sendButton" class="send-btn">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>

            <!-- Chat Info Bar (thread info + new chat button) -->
            <div class="chat-info">
                <span id="threadInfo">{(serverThreadData && serverThreadData.title) ? serverThreadData.title : 'New Conversation'}</span>
                <button id="newChatBtn" class="new-chat-btn">
                    <i class="fa-solid fa-plus"></i> New Chat
                </button>
            </div>
        </div>
    </div>
</App>

<!-- Client-Side JavaScript -->
<script is:inline src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
<ChatScript
    serverThreadData={{
        threadId: serverThreadData?.id || null,
        threadTitle: serverThreadData?.title || null,
        threadNotFound: !!threadNotFound
    }}
    isThreadPage={true}
/>
